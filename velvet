#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * VelvetCMS Command Line Interface
 */

// Find autoloader
$autoloadPaths = [
    __DIR__ . '/vendor/autoload.php',
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../vendor/autoload.php',
    __DIR__ . '/../../../vendor/autoload.php',
];

$autoloadPath = null;
foreach ($autoloadPaths as $path) {
    if (file_exists($path)) {
        $autoloadPath = $path;
        break;
    }
}

if (!$autoloadPath) {
    fwrite(STDERR, "Error: Composer autoloader not found.\n");
    fwrite(STDERR, "Run: composer install --no-dev \n");
    exit(1);
}

require $autoloadPath;

\VelvetCMS\Core\Tenancy\TenancyManager::bootstrapFromCli();

// Bootstrap application
$app = null;
try {
    $app = require __DIR__ . '/bootstrap/app.php';

    $app->boot();

    // Application instance is already set in bootstrap/app.php via App::setInstance()
} catch (\Throwable $e) {
    // If bootstrap fails, we might be in a fresh install
    // Create minimal bootstrap for installation commands
    if (!defined('VELVET_BASE_PATH')) {
        define('VELVET_BASE_PATH', __DIR__);
    }
    
    // Load helpers if available
    if (file_exists(__DIR__ . '/src/Support/helpers.php')) {
        require __DIR__ . '/src/Support/helpers.php';
    }
}

use VelvetCMS\Commands\CommandRegistry;
use VelvetCMS\Commands\ListCommand;
use VelvetCMS\Commands\HelpCommand;
use VelvetCMS\Commands\VersionCommand;
use VelvetCMS\Commands\InstallCommand;
use VelvetCMS\Commands\MigrateCommand;
use VelvetCMS\Commands\Cache\ClearCommand as CacheClearCommand;
use VelvetCMS\Commands\Config\CacheCommand as ConfigCacheCommand;
use VelvetCMS\Commands\Config\ClearCommand as ConfigClearCommand;
use VelvetCMS\Commands\Config\ListCommand as ConfigListCommand;
use VelvetCMS\Commands\Config\GetCommand as ConfigGetCommand;
use VelvetCMS\Commands\Config\SetCommand as ConfigSetCommand;
use VelvetCMS\Commands\Config\PublishCommand as ConfigPublishCommand;
use VelvetCMS\Commands\ServeCommand;
use VelvetCMS\Commands\Page\MakeCommand as PageMakeCommand;
use VelvetCMS\Commands\Page\ListCommand as PageListCommand;
use VelvetCMS\Commands\Page\PublishCommand as PagePublishCommand;
use VelvetCMS\Commands\Page\DeleteCommand as PageDeleteCommand;
use VelvetCMS\Commands\OptimizeCommand;

$registry = new CommandRegistry();

if ($app) {
    try {
        $app->instance(CommandRegistry::class, $registry);
        $app->alias('commands', CommandRegistry::class);

        $events = $app->make('events');
        $events->dispatch('commands.registering', $registry);
    } catch (\Throwable $e) {
        // If the event dispatcher is unavailable, continue without module commands
    }
}

// Register commands that don't need full app
$registry->register('version', VersionCommand::class);
$registry->register('install', InstallCommand::class);
$registry->register('serve', ServeCommand::class);
$registry->register('cache:clear', CacheClearCommand::class);
$registry->register('config:cache', ConfigCacheCommand::class);
$registry->register('config:clear', ConfigClearCommand::class);
$registry->register('config:list', ConfigListCommand::class);
$registry->register('config:get', ConfigGetCommand::class);
$registry->register('config:set', ConfigSetCommand::class);
$registry->register('config:publish', ConfigPublishCommand::class);
$registry->register('route:clear', \VelvetCMS\Commands\Route\ClearCommand::class);
$registry->register('diagnose', \VelvetCMS\Commands\DiagnoseCommand::class);

// Register commands that need full app (if available)
if ($app) {
    try {
        $app->make('pages');

        $registry->register('page:make', PageMakeCommand::class);
        $registry->register('page:list', PageListCommand::class);
        $registry->register('page:publish', PagePublishCommand::class);
        $registry->register('page:delete', PageDeleteCommand::class);
        $registry->register('content:migrate', \VelvetCMS\Commands\Content\MigrateContentCommand::class);
        $registry->register('migrate', MigrateCommand::class);
        $registry->register('optimize', OptimizeCommand::class);
        $registry->register('route:cache', \VelvetCMS\Commands\Route\CacheCommand::class);

        $registry->register('make:controller', \VelvetCMS\Commands\Make\MakeControllerCommand::class);
        $registry->register('make:middleware', \VelvetCMS\Commands\Make\MakeMiddlewareCommand::class);
        $registry->register('make:model', \VelvetCMS\Commands\Make\MakeModelCommand::class);
        $registry->register('make:command', \VelvetCMS\Commands\Make\MakeConsoleCommand::class);
        $registry->register('make:module', \VelvetCMS\Commands\Make\MakeModuleCommand::class);

        $registry->register('module:list', \VelvetCMS\Commands\Module\ListModuleCommand::class);
        $registry->register('module:compile', \VelvetCMS\Commands\Module\CompileModuleCommand::class);
        $registry->register('module:enable', \VelvetCMS\Commands\Module\EnableModuleCommand::class);
        $registry->register('module:disable', \VelvetCMS\Commands\Module\DisableModuleCommand::class);
    } catch (\Throwable $e) {
        // Services not available, skip
    }
}

// List command needs special handling (needs registry)
// We'll register it but handle instantiation specially
$registry->register('list', ListCommand::class);
$registry->register('help', HelpCommand::class);

// Parse command line arguments
[$commandName, $arguments, $options] = $registry->parseArgv($argv);

if (!$commandName) {
    $versionRegistry = \VelvetCMS\Core\VersionRegistry::instance();
    $coreVersion = $versionRegistry->getVersion('core');

    echo "\033[1mVelvetCMS Core\033[0m \033[33m{$coreVersion}\033[0m\n";

    $modules = $versionRegistry->getModules();
    if (!empty($modules)) {
        echo "\033[90mModules:\033[0m";
        foreach ($modules as $name => $meta) {
            $moduleVersion = $meta['version'] ?? 'unknown';
            $stability = $meta['stability'] ?? null;
            $suffix = $stability ? sprintf('%s (%s)', $moduleVersion, $stability) : $moduleVersion;
            echo " {$name}@{$suffix}";
        }
        echo "\n";
    }

    echo "\n\033[33mUsage:\033[0m\n";
    echo "  velvet <command> [arguments] [options]\n\n";
    echo "Run '\033[36mvelvet list\033[0m' to see all available commands\n";
    echo "Run '\033[36mvelvet help <command>\033[0m' for command help\n\n";
    exit(0);
}

$exitCode = $registry->run($commandName, $arguments, $options);
exit($exitCode);
